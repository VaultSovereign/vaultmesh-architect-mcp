name: Verify Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/verify-docs.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.md'
      - 'docs/**'

jobs:
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            **/*.md
            !node_modules/**
            !coverage/**

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run cspell
        uses: streetsidesoftware/cspell-action@v6
        with:
          files: |
            **/*.md
            !node_modules/**
            !coverage/**
          incremental_files_only: false

  mermaid-validate:
    name: Validate Mermaid Diagrams
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'mermaid') || contains(github.event.pull_request.title, 'mermaid')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Find Mermaid files
        id: find-files
        run: |
          echo "files=$(find docs -name '*.mmd' -o -name '*.mermaid' | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Validate Mermaid syntax
        if: steps.find-files.outputs.files != ''
        run: |
          for file in ${{ steps.find-files.outputs.files }}; do
            echo "Validating $file"
            mmdc -i "$file" -o /tmp/test.svg || exit 1
          done

  docs-structure:
    name: Check Documentation Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files
        run: |
          required_files=(
            "README.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "SECURITY.md"
            "LICENSE"
            "CHANGELOG.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done

      - name: Check docs directory structure
        run: |
          if [ ! -d "docs" ]; then
            echo "‚ö†Ô∏è  Warning: docs/ directory not found"
            exit 0
          fi
          
          echo "üìÅ Documentation structure:"
          tree -L 2 docs/ || ls -R docs/

  no-secrets:
    name: Check for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
