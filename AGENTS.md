# Repository Guidelines

## Project Structure & Module Organization
- Root: `server.js` (Node ESM MCP server), `package.json`, `Makefile`.
- Specs: `specs/` (constitution `vaultmesh_mcp_digital_twin.yaml` + schema).
- Governance: `governance/` (`lawchain/`, `anchor-receipts/`, `incidents/`, `drafts/`, `scripts/`).
- Rust crates: `crates/<name>/` (Cargo-based skeletons generated by tools).
- Tests: `tests/**/*.spec.mjs` with helpers in `tests/helpers/` and snapshots in `tests/__snapshots__/`.
- Tooling & assets: `manifests/`, `config/`, `docs/`, `scripts/`, `prompts/`.

## Build, Test, and Development Commands
- Install: `npm install`
- Run (stdio): `npm start -- --stdio`
- Tests: `npm test` (Vitest), watch: `npm run test:watch`
- Coverage: `npm run coverage` then `npm run coverage:open` (enforces L85/F85/B80/S85)
- Hash manifest: `npm run merkle` → writes `manifests/hash-manifest.json`
- Anchor (dry-run by default): `npm run anchor`
- Release verification: `bash scripts/verify_release.sh v1.0.0` or `make verify-release RELEASE_TAG=v1.0.0`
- Tag + draft release: `make release RELEASE_TAG=vYYYY.MM.DD`

## Coding Style & Naming Conventions
- JavaScript: ESM (`type: module`), 2‑space indent, `camelCase` for vars/functions, `kebab-case` for subsystem names.
- Tests: name files `*.spec.mjs` under `tests/`; keep deterministic I/O and avoid global state.
- JSON/YAML: 2‑space indent; stable key order when generating JSON.
- Rust crates: `snake_case` APIs; crate dir `crates/<kebab-name>/` with `Cargo.toml` and `src/lib.rs`.

## Testing Guidelines
- Framework: Vitest; config in `vitest.config.mjs`.
- Conventions: unit and black‑box stdio tests; snapshots live in `tests/__snapshots__/`.
- Coverage: run `npm run coverage`; PRs must not reduce thresholds.
- E2E tip: set `VM_WORKDIR=tmp-e2e` to isolate artifacts; use `tests/helpers/rpcClient.js`.

## Commit & Pull Request Guidelines
- Use Conventional Commits: e.g., `feat(tem): …`, `ci(verify): …`, `docs(ci): …` (see `git log`).
- PRs: include description, linked issues, relevant logs/screenshots, and update docs/specs when behavior changes.
- Checks: CI green, coverage maintained, `npm run merkle`/`anchor` outputs stable in dry‑run.

## Security & Configuration Tips
- Defaults: `DRY_RUN=true`. Configure `RFC3161_URL`, `ETH_RPC_URL`, `BTC_RPC_URL` only for live anchors.
- Keys: provide `LAWCHAIN_PRIVATE_KEY_PEM` via env; never commit secrets.
- Workdir: use `VM_WORKDIR` to redirect all outputs during local runs.

## Architecture & Agent Bridge
- Architecture: `specs/vaultmesh_mcp_digital_twin.yaml` and `docs/architecture/tem-first-healthcare.md` (Tem‑First security track for healthcare).
- Capability: see `governance/capabilities/tem_first_security_automation.md` for scopes and CI usage.
- Claude Bridge: if using the VaultMesh skill pack (`vaultmesh-architect.skill`), run this MCP server (`node server.js --stdio`) and point the skill/client to it. Keep rituals (spawn/anchor/tem) auditable under `governance/`.
